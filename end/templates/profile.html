{% extends 'frame.html' %}

{% block css %}
    <link href="../static/assets/css/bootstrap-editable.min.css" rel="stylesheet" />
    <link href="../static/assets/css/jquery.gritter.min.css" rel="stylesheet" />
    <link href="../static/assets/css/datepicker.min.css" rel="stylesheet" />
{% endblock %}


{% block pageheader %}
    用户信息
{% endblock %}

{% block content %}
<div>
    <div id="user-profile-1" class="user-profile row">
        <div class="col-xs-12 col-sm-3 center">
            <div>
                <span class="profile-picture">
                    <img id="avatar" class="editable img-responsive" alt="Alex's Avatar" width="180" height="180" src="../static/images/user.png" />
                </span>

                <div class="space-4"></div>

                <div class="width-80 label label-info label-xlg arrowed-in arrowed-in-right">
                    <div class="inline position-relative">
                        <a href="#" class="user-title-label dropdown-toggle" data-toggle="dropdown">
                            <i class="ace-icon fa fa-circle light-green"></i>
                            &nbsp;
                            <span class="white">{{ username }}</span>
                        </a>
                    </div>
                </div>
            </div>

            <div class="space-6"></div>

        </div>
    <!--
        <div class="col-xs-12 col-sm-9">

            <div class="space-12"></div>

            <div class="profile-user-info profile-user-info-striped">
                <div class="profile-info-row">
                    <div class="profile-info-name"> 用户名 </div>

                    <div class="profile-info-value">
                        <span class="editable" id="username">{{ username }}</span>
                    </div>
                </div>

                <div class="profile-info-row">
                    <div class="profile-info-name"> 积分 </div>

                    <div class="profile-info-value">
                        <span class="editable" id="age">38</span>
                    </div>
                </div>

                <div class="profile-info-row">
                    <div class="profile-info-name"> Joined </div>

                    <div class="profile-info-value">
                        <span class="editable" id="signup">2010/06/20</span>
                    </div>
                </div>

                <div class="profile-info-row">
                    <div class="profile-info-name"> 最后登录时间 </div>

                    <div class="profile-info-value">
                        <span id="login">3 hours ago</span>
                    </div>
                </div>

                <div class="profile-info-row">
                    <div class="profile-info-name"> 关于我 </div>

                    <div class="profile-info-value">
                        <span class="editable" id="about">Editable as WYSIWYG</span>
                    </div>
                </div>
            </div>
        </div>
    -->
        <div class="col-xs-12 col-sm-9">
            <form class="form-horizontal">
        <div class="tabbable">
            <ul class="nav nav-tabs padding-16">
                <li class="active">
                    <a data-toggle="tab" href="#edit-basic">
                        <i class="green ace-icon fa fa-pencil-square-o bigger-125"></i>
                        基本信息
                    </a>
                </li>
                <li>
                    <a data-toggle="tab" href="#edit-password">
                        <i class="blue ace-icon fa fa-key bigger-125"></i>
                        修改密码
                    </a>
                </li>
            </ul>

            <div class="tab-content profile-edit-tab-content">
                <div id="edit-basic" class="tab-pane in active">
                    <h4 class="header blue bolder smaller">基本信息</h4>

                    <div class="row">

                        <div class="vspace-12-sm"></div>

                        <div class="col-xs-12 col-sm-8">
                            <div class="form-group">
                                <label class="col-sm-4 control-label no-padding-right" for="form-field-username">用户名</label>

                                <div class="col-sm-8">
                                    <input class="col-xs-12 col-sm-10" type="text" id="form-field-username" placeholder="Username" value="{{ username }}" />
                                </div>
                            </div>

                            <div class="space-4"></div>

                            <div class="form-group">
                                <label class="col-sm-4 control-label no-padding-right" for="form-field-first">昵称</label>

                                <div class="col-sm-8">
                                    <input class="col-xs-12 col-sm-10" type="text" id="form-field-first" placeholder="First Name" value="dh" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr />
                    <div class="form-group">
                        <label class="col-sm-3 control-label no-padding-right" for="form-field-date">出生年月</label>

                        <div class="col-sm-9">
                            <div class="input-medium">
                                <div class="input-group">
                                    <input class="input-medium date-picker" id="form-field-date" type="text" data-date-format="dd-mm-yyyy" placeholder="dd-mm-yyyy" />
                                    <span class="input-group-addon">
                                        <i class="ace-icon fa fa-calendar"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label no-padding-right">性别</label>

                        <div class="col-sm-9">
                            <label class="inline">
                                <input name="form-field-radio" type="radio" class="ace" />
                                <span class="lbl middle"> 男</span>
                            </label>

                            &nbsp; &nbsp; &nbsp;
                            <label class="inline">
                                <input name="form-field-radio" type="radio" class="ace" />
                                <span class="lbl middle"> 女</span>
                            </label>
                        </div>
                    </div>

                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label no-padding-right" for="form-field-comment">个性签名</label>

                        <div class="col-sm-9">
                            <textarea id="form-field-comment"></textarea>
                        </div>
                    </div>

                    <div class="space"></div>
                    <h4 class="header blue bolder smaller">联系信息</h4>

                    <div class="form-group">
                        <label class="col-sm-3 control-label no-padding-right" for="form-field-email">邮件</label>

                        <div class="col-sm-9">
                            <span class="input-icon input-icon-right">
                                <input type="email" id="form-field-email" value="alexdoe@gmail.com" />
                                <i class="ace-icon fa fa-envelope"></i>
                            </span>
                        </div>
                    </div>

                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label no-padding-right" for="form-field-phone">手机</label>

                        <div class="col-sm-9">
                            <span class="input-icon input-icon-right">
                                <input class="input-medium input-mask-phone" type="text" id="form-field-phone" />
                                <i class="ace-icon fa fa-phone fa-flip-horizontal"></i>
                            </span>
                        </div>
                    </div>

                </div>

                <div id="edit-password" class="tab-pane">
                    <div class="space-10"></div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label no-padding-right" for="form-field-pass1">新密码</label>

                        <div class="col-sm-9">
                            <input type="password" id="form-field-pass1" />
                        </div>
                    </div>

                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label no-padding-right" for="form-field-pass2">确认密码</label>

                        <div class="col-sm-9">
                            <input type="password" id="form-field-pass2" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="clearfix form-actions">
            <div class="col-md-offset-3 col-md-9">
                <button class="btn btn-info" type="button">
                    <i class="ace-icon fa fa-check bigger-110"></i>
                    保存
                </button>

                &nbsp; &nbsp;
                <button class="btn" type="reset">
                    <i class="ace-icon fa fa-undo bigger-110"></i>
                    重置
                </button>
            </div>
        </div>
    </form>
        </div>
    </div>
</div>
{% endblock %}

{% block tailjs %}
    <script src="../static/assets/js/jquery.gritter.min.js"></script>
    <script src="../static/assets/js/bootstrap-editable.min.js"></script>
    <script src="../static/assets/js/ace-editable.min.js"></script>
    <script src="../static/assets/js/bootstrap-wysiwyg.min.js"></script>
    <script type="text/javascript">
        jQuery(function($) {

            //editables on first profile page
            $.fn.editable.defaults.mode = 'inline';
            $.fn.editableform.loading = "<div class='editableform-loading'><i class='ace-icon fa fa-spinner fa-spin fa-2x light-blue'></i></div>";
            $.fn.editableform.buttons = '<button type="submit" class="btn btn-info editable-submit"><i class="ace-icon fa fa-check"></i></button>'+
                                        '<button type="button" class="btn editable-cancel"><i class="ace-icon fa fa-times"></i></button>';

            //editables

            //text editable
            $('#username')
            .editable({
                type: 'text',
                name: 'username'
            });

            //custom date editable
            $('#signup').editable({
                type: 'adate',
                date: {
                    //datepicker plugin options
                        format: 'yyyy/mm/dd',
                    viewformat: 'yyyy/mm/dd',
                     weekStart: 1

                    //,nativeUI: true//if true and browser support input[type=date], native browser control will be used
                    //,format: 'yyyy-mm-dd',
                    //viewformat: 'yyyy-mm-dd'
                }
            })

            $('#age').editable({
                type: 'spinner',
                name : 'age',
                spinner : {
                    min : 16,
                    max : 99,
                    step: 1,
                    on_sides: true
                    //,nativeUI: true//if true and browser support input[type=number], native browser control will be used
                }
            });

            $('#about').editable({
                mode: 'inline',
                type: 'wysiwyg',
                name : 'about',

                wysiwyg : {
                    //css : {'max-width':'300px'}
                },
                success: function(response, newValue) {
                }
            });



            // *** editable avatar *** //
            try {//ie8 throws some harmless exceptions, so let's catch'em

                //first let's add a fake appendChild method for Image element for browsers that have a problem with this
                //because editable plugin calls appendChild, and it causes errors on IE at unpredicted points
                try {
                    document.createElement('IMG').appendChild(document.createElement('B'));
                } catch(e) {
                    Image.prototype.appendChild = function(el){}
                }

                var last_gritter
                $('#avatar').editable({
                    type: 'image',
                    name: 'avatar',
                    value: null,
                    image: {
                        //specify ace file input plugin's options here
                        btn_choose: '更改头像',
                        droppable: true,
                        maxSize: 110000,//~100Kb

                        //and a few extra ones here
                        name: 'avatar',//put the field name here as well, will be used inside the custom plugin
                        on_error : function(error_type) {//on_error function will be called when the selected file has a problem
                            if(last_gritter) $.gritter.remove(last_gritter);
                            if(error_type == 1) {//file format error
                                last_gritter = $.gritter.add({
                                    title: '上传的文件不是一张图片！',
                                    text: '请选择一个 jpg|gif|png 格式的图片！',
                                    class_name: 'gritter-error gritter-center'
                                });
                            } else if(error_type == 2) {//file size rror
                                last_gritter = $.gritter.add({
                                    title: '上传图片太大！',
                                    text: '头像大小不能超过100Kb!',
                                    class_name: 'gritter-error gritter-center'
                                });
                            }
                            else {//other error
                            }
                        },
                        on_success : function() {
                            $.gritter.removeAll();
                        }
                    },
                    url: function(params) {
                        // ***UPDATE AVATAR HERE*** //
                        //for a working upload example you can replace the contents of this function with
                        //examples/profile-avatar-update.js

                        var deferred = new $.Deferred

                        var value = $('#avatar').next().find('input[type=hidden]:eq(0)').val();
                        if(!value || value.length == 0) {
                            deferred.resolve();
                            return deferred.promise();
                        }


                        //dummy upload
                        setTimeout(function(){
                            if("FileReader" in window) {
                                //for browsers that have a thumbnail of selected image
                                var thumb = $('#avatar').next().find('img').data('thumb');
                                if(thumb) $('#avatar').get(0).src = thumb;
                            }

                            deferred.resolve({'status':'OK'});

                            if(last_gritter) $.gritter.remove(last_gritter);
                            last_gritter = $.gritter.add({
                                title: '头像更新成功!',
                                text: 'Uploading to server can be easily implemented. A working example is included with the template.',
                                class_name: 'gritter-info gritter-center'
                            });

                         } , parseInt(Math.random() * 800 + 800))

                        return deferred.promise();

                        // ***END OF UPDATE AVATAR HERE*** //
                    },

                    success: function(response, newValue) {
                    }
                })
            }catch(e) {}

            /**
            //let's display edit mode by default?
            var blank_image = true;//somehow you determine if image is initially blank or not, or you just want to display file input at first
            if(blank_image) {
                $('#avatar').editable('show').on('hidden', function(e, reason) {
                    if(reason == 'onblur') {
                        $('#avatar').editable('show');
                        return;
                    }
                    $('#avatar').off('hidden');
                })
            }
            */

            //another option is using modals
            $('#avatar2').on('click', function(){
                var modal =
                '<div class="modal fade">\
                  <div class="modal-dialog">\
                   <div class="modal-content">\
                    <div class="modal-header">\
                        <button type="button" class="close" data-dismiss="modal">&times;</button>\
                        <h4 class="blue">Change Avatar</h4>\
                    </div>\
                    \
                    <form class="no-margin">\
                     <div class="modal-body">\
                        <div class="space-4"></div>\
                        <div style="width:75%;margin-left:12%;"><input type="file" name="file-input" /></div>\
                     </div>\
                    \
                     <div class="modal-footer center">\
                        <button type="submit" class="btn btn-sm btn-success"><i class="ace-icon fa fa-check"></i> Submit</button>\
                        <button type="button" class="btn btn-sm" data-dismiss="modal"><i class="ace-icon fa fa-times"></i> Cancel</button>\
                     </div>\
                    </form>\
                  </div>\
                 </div>\
                </div>';


                var modal = $(modal);
                modal.modal("show").on("hidden", function(){
                    modal.remove();
                });

                var working = false;

                var form = modal.find('form:eq(0)');
                var file = form.find('input[type=file]').eq(0);
                file.ace_file_input({
                    style:'well',
                    btn_choose:'Click to choose new avatar',
                    btn_change:null,
                    no_icon:'ace-icon fa fa-picture-o',
                    thumbnail:'small',
                    before_remove: function() {
                        //don't remove/reset files while being uploaded
                        return !working;
                    },
                    allowExt: ['jpg', 'jpeg', 'png', 'gif'],
                    allowMime: ['image/jpg', 'image/jpeg', 'image/png', 'image/gif']
                });

                form.on('submit', function(){
                    if(!file.data('ace_input_files')) return false;

                    file.ace_file_input('disable');
                    form.find('button').attr('disabled', 'disabled');
                    form.find('.modal-body').append("<div class='center'><i class='ace-icon fa fa-spinner fa-spin bigger-150 orange'></i></div>");

                    var deferred = new $.Deferred;
                    working = true;
                    deferred.done(function() {
                        form.find('button').removeAttr('disabled');
                        form.find('input[type=file]').ace_file_input('enable');
                        form.find('.modal-body > :last-child').remove();

                        modal.modal("hide");

                        var thumb = file.next().find('img').data('thumb');
                        if(thumb) $('#avatar2').get(0).src = thumb;

                        working = false;
                    });


                    setTimeout(function(){
                        deferred.resolve();
                    } , parseInt(Math.random() * 800 + 800));

                    return false;
                });

            });



            //////////////////////////////
            $('#profile-feed-1').ace_scroll({
                height: '250px',
                mouseWheelLock: true,
                alwaysVisible : true
            });

            $('a[ data-original-title]').tooltip();

            $('.easy-pie-chart.percentage').each(function(){
            var barColor = $(this).data('color') || '#555';
            var trackColor = '#E2E2E2';
            var size = parseInt($(this).data('size')) || 72;
            $(this).easyPieChart({
                barColor: barColor,
                trackColor: trackColor,
                scaleColor: false,
                lineCap: 'butt',
                lineWidth: parseInt(size/10),
                animate:false,
                size: size
            }).css('color', barColor);
            });

            ///////////////////////////////////////////

            //right & left position
            //show the user info on right or left depending on its position
            $('#user-profile-2 .memberdiv').on('mouseenter touchstart', function(){
                var $this = $(this);
                var $parent = $this.closest('.tab-pane');

                var off1 = $parent.offset();
                var w1 = $parent.width();

                var off2 = $this.offset();
                var w2 = $this.width();

                var place = 'left';
                if( parseInt(off2.left) < parseInt(off1.left) + parseInt(w1 / 2) ) place = 'right';

                $this.find('.popover').removeClass('right left').addClass(place);
            }).on('click', function(e) {
                e.preventDefault();
            });


            ///////////////////////////////////////////
            $('#user-profile-3')
            .find('input[type=file]').ace_file_input({
                style:'well',
                btn_choose:'Change avatar',
                btn_change:null,
                no_icon:'ace-icon fa fa-picture-o',
                thumbnail:'large',
                droppable:true,

                allowExt: ['jpg', 'jpeg', 'png', 'gif'],
                allowMime: ['image/jpg', 'image/jpeg', 'image/png', 'image/gif']
            })
            .end().find('button[type=reset]').on(ace.click_event, function(){
                $('#user-profile-3 input[type=file]').ace_file_input('reset_input');
            })
            .end().find('.date-picker').datepicker().next().on(ace.click_event, function(){
                $(this).prev().focus();
            })
            $('.input-mask-phone').mask('(999) 999-9999');

            $('#user-profile-3').find('input[type=file]').ace_file_input('show_file_list', [{type: 'image', name: $('#avatar').attr('src')}]);


            ////////////////////
            //change profile
            $('[data-toggle="buttons"] .btn').on('click', function(e){
                var target = $(this).find('input[type=radio]');
                var which = parseInt(target.val());
                $('.user-profile').parent().addClass('hide');
                $('#user-profile-'+which).parent().removeClass('hide');
            });



            /////////////////////////////////////
            $(document).one('ajaxloadstart.page', function(e) {
                //in ajax mode, remove remaining elements before leaving page
                try {
                    $('.editable').editable('destroy');
                } catch(e) {}
                $('[class*=select2]').remove();
            });
        });
    </script>
    <script type="text/javascript">
    function checkvalid() {
        var username = $("[name='username']").val();
        var oldpassword = $("[name='oldpassword']").val();
        var newpassword = $("[name='newpassword']").val();
        var confirmnewpassword = $("[name='confirmnewpassword']").val();
        var mobile_patrn = /^[+]{0,1}(\d){1,3}[ ]?([-]?((\d)|[ ]){1,12})+$/;
        var mobile = $("[name='mobile']").val();
        var email_patrn = /\w@\w*\.\w/;
        var email = $("[name='email']").val();
        var address = $("[name='address']").val();
        var zipcode_patrn = /^[a-zA-Z0-9 ]{3,12}$/;
        var zipcode = $("[name='zipcode']").val();
        var idcardtype = $("[name='idcardtype']");
        var birthday_patrn = /^(19|20)\d\d(0[1-9]|1[012])(0[1-9]|[12]\d|3[01])$/;
        var birthday = $("[name='birthday']").val();
        var contact = $("[name='contact']").val();
        var contactmobile = $("[name='contactmobile']").val();
        if(username.length < 5 || username.length > 20) {
            $("[name='username']").select();
            return false;
        }
        if(oldpassword != "666666") {
            $("[name='oldpassword']").select();
            $("[name='oldpassword_help']").css('display','block');
            return false;
        }
        else {
            $("[name='oldpassword_help']").css('display','none');
        }
        if(newpassword.length < 6 || newpassword.length > 20) {
            $("[name='newpassword']").select();
            return false;
        }
        if(newpassword != confirmnewpassword) {
            $("[name='confirmnewpassword']").select();
            $("[name='confirmnewpassword_help']").css('display','block');
            return false;
        }
        else {
            $("[name='confirmnewpassword_help']").css('display','none');
        }
        if (!mobile_patrn.exec(mobile)) {
            $("[name='mobile']").select();
            $("[name='mobile_help']").css('display','block');
            return false;
        }
        else {
            $("[name='mobile_help']").css('display','none');
        }
        if (!email_patrn.exec(email)) {
            $("[name='email']").select();
            $("[name='email_help']").css('display','block');
            return false;
        }
        else {
            $("[name='email_help']").css('display','none');
        }
        if(address.length < 1 || address.length > 60) {
            $("[name='address']").select();
            return false;
        }
        if (!zipcode_patrn.exec(zipcode)) {
            $("[name='zipcode']").select();
            $("[name='zipcode_help']").css('display','block');
            return false;
        }
        else {
            $("[name='zipcode_help']").css('display','none');
        }
        if (idcardtype.val() == "") {
            // $("[name='idcardtype']").find("option:selected").text();
            return false;
        }
        if (!birthday_patrn.exec(birthday)) {
            $("[name='birthday']").select();
            return false;
        }
        if(contact.length < 2 || contact.length > 20) {
            $("[name='contact']").select();
            return false;
        }
        if (!mobile_patrn.exec(contactmobile)) {
            $("[name='contactmobile']").select();
            $("[name='contactmobile_help']").css('display','block');
            return false;
        }
        else {
            $("[name='contactmobile_help']").css('display','none');
        }
        return true;
    }
    </script>
{% endblock %}